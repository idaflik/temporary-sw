---
title: "Frontex Grants"
author: ""
date: ""
output: html_document
---

to do's: 

- clean country names
- clean project names
- clean beneficiary names
- create non-timeline visualisations for aggregate of all years
- check more creative visualisations

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```


```{r echo = F}

library(needs)
needs(tidyverse,
      sf,
      # ggalluvial,
      wbstats,
      scales,
      # ggsankey,
      networkD3,
      readxl,
      ggplot2)

sheetnames <- excel_sheets("Grants_2008_2022.xlsx")

data_allyears <- c(1:length(sheetnames))%>%
  map_dfr(function(current_sheet_nr){# current_sheet_nr <- 15
    test <- read_excel("Grants_2008_2022.xlsx", sheet = current_sheet_nr, col_types = "text")%>%
      ## fix the numbers later
      mutate(
        `Total awarded in EUR` = case_when(
          sheetnames[current_sheet_nr] %in% c("y2009") ~ str_remove_all(`Total awarded in EUR`, " |,"),
          sheetnames[current_sheet_nr] %in% c("y2015") ~ str_remove_all(`Total awarded in EUR`, "\\."),
                    sheetnames[current_sheet_nr] %in% c("y2021") ~ str_replace_all(str_remove_all(`Total awarded in EUR`, " |\\."), ",", "."),
          sheetnames[current_sheet_nr] %in% c("y2014", "y2021") ~ str_replace_all(str_remove_all(`Total awarded in EUR`, "\\."), ",", "."),
          TRUE ~ as.character(`Total awarded in EUR`)),
        year = sheetnames[current_sheet_nr])
    
    if(sheetnames[current_sheet_nr] %in% c("y2008")){
       test <- test %>%
       rename(`Unit/\nSector` = `Unit\nSector`)}else{
         test <- test
       }
  })%>% 
      rename(grant_no = "Grant No",
             unit_sector = "Unit/\nSector",
             country = Country,
             beneficiary = "Name of Beneficiary",
             address = "Address of Beneficiary",
             project = "Project No. and title",
             eur = "Total awarded in EUR")%>%
  mutate(`eur` = as.numeric(`eur`),
         year = as.numeric(str_remove_all(year, "y")))%>%
  filter(!is.na(`eur`))

data <- data_allyears %>%
  filter(year == 2022)

# data_allyears %>% group_by(year) %>% filter(row_number() == 1)
# 
# ## check if old 2022 data is the same as new data
# ## result: yes!
# data <- read_excel("grants-awarded-in-2022.xlsx")%>%
#   drop_na()
# 
# testdata_2022 <- data_allyears %>%
#   filter(year == 2022)%>%
#   full_join(data %>% dplyr::select(-`unit_sector`))
# test<-testdata_2022 %>% group_by(`grant_no`)%>%mutate(n = n())%>%filter(n>1)
# 
# data %>% head(10)
```

## Development over time per state

(top 15 countries, rest grouped)

```{r echo = FALSE}

plotdata <- data_allyears %>%
         group_by(country, year)%>%
         summarize(grants = sum(`eur`))

test <- plotdata %>%
  group_by(country)%>%
  summarize(grants = sum(grants))%>%
  arrange(desc(grants))%>%
  head(15)

ggplot(plotdata %>%
         mutate(country = if_else(
           country %in% test$country,
           country,
           "_rest"
         ))%>%
         group_by(country, year)%>%
         summarize(grants = sum(grants)))+
  geom_area(
    mapping = aes(
      x = year,
      y = grants,
      fill = country,
      group = country
    ),
    color = "white"
  )+
  theme_minimal()

```

## Development over time per unit/sector

top 10, rest grouped

```{r echo = FALSE}

plotdata <- data_allyears %>%
         group_by(`unit_sector`, year)%>%
         summarize(grants = sum(`eur`))%>%
  ungroup()

test <- plotdata %>%
  group_by(`unit_sector`)%>%
  summarize(grants = sum(grants))%>%
  arrange(desc(grants))%>%
  head(10)

plotdata <- plotdata %>%
         mutate(`unit_sector` = if_else(
           `unit_sector` %in% test$`unit_sector`,
           `unit_sector`,
           "_rest"
         ))%>%
         group_by(`unit_sector`, year)%>%
         summarize(grants = sum(grants))%>%
         ungroup()

vars <- plotdata$unit_sector%>%unique()

years <- plotdata$year%>%unique()

test <- data.frame(
  year = rep(c(years), length(vars)),
  unit_sector = sort(rep(vars, length(years)))
)%>%
  left_join(
    plotdata
  )%>%
  mutate(grants = if_else(is.na(grants), 0, grants))

ggplot(test)+
  geom_area(
    mapping = aes(
      x = year,
      y = grants,
      fill = unit_sector,
      group = unit_sector
    ),
    color = "white"
  )+
  theme_minimal()

```

## Development over time per project

top 10, rest grouped

to do: clean project names, extraxct relevant information (e.g. "technical equipment")

```{r echo = FALSE}

plotdata <- data_allyears %>%
  ## remove year strings
  mutate(project = str_remove_all(project, "^[:digit:]{4}\\/"))%>%
         group_by(`project`, year)%>%
         summarize(grants = sum(`eur`))%>%
  ungroup()

test <- plotdata %>%
  group_by(`project`)%>%
  summarize(grants = sum(grants))%>%
  arrange(desc(grants))%>%
  head(10)

plotdata <- plotdata %>%
         mutate(`project` = if_else(
           `project` %in% test$`project`,
           `project`,
           "_rest"
         ))%>%
         group_by(`project`, year)%>%
         summarize(grants = sum(grants))%>%
         ungroup()

vars <- plotdata$project%>%unique()

years <- plotdata$year%>%unique()

test <- data.frame(
  year = rep(c(years), length(vars)),
  project = sort(rep(vars, length(years)))
)%>%
  left_join(
    plotdata
  )%>%
  mutate(grants = if_else(is.na(grants), 0, grants))

ggplot(test)+
  geom_area(
    mapping = aes(
      x = year,
      y = grants,
      fill = project,
      group = project
    ),
    color = "white"
  )+
  theme_minimal()

```

## Data for 2022 only

### Total of grants recieved by state

```{r echo = FALSE}

plotdata <- data%>%
             group_by(country)%>%
             summarize(total = sum(`eur`, na.rm=T))

ggplot()+
  geom_bar(plotdata,
           mapping = aes(x = reorder(country, total),
                         y = total),
           stat = "identity")+
  coord_flip()+
  scale_y_continuous(labels = label_dollar(prefix = "", suffix = "€",))+
  theme(axis.title = element_blank())

```

### Total of grants recieved by state, colored by unit/sector

```{r echo = FALSE, message=FALSE}

plotdata <- data %>%
             group_by(country, `unit_sector`)%>%
             summarize(total_project = sum(`eur`, na.rm=T))%>%
  group_by(country)%>%
             mutate(total = sum(total_project, na.rm=T))

ggplot()+
  geom_bar(plotdata,
           mapping = aes(x = reorder(country, total),
                         y = total_project,
                         fill = `unit_sector`),
           stat = "identity")+
  coord_flip()+
  scale_y_continuous(labels = label_dollar(prefix = "", suffix = "€",))+
  theme(axis.title = element_blank())

```

<!-- ## Total grants per capita recieved by state (€ per person) -->

<!-- ```{r echo  = FALSE, warning=FALSE} -->
<!-- pop_data <- wb_data("SP.POP.TOTL", start_date = 2022) -->
<!-- plotdata <- data %>% -->
<!--   mutate(country = case_when( -->
<!--     country == "Bosna and Herzegovina" ~ "Bosnia and Herzegovina", -->
<!--     country == "Republic of N.Macedonia" ~ "North Macedonia", -->
<!--     country == "Egypt" ~ "Egypt, Arab Rep.", -->
<!--     country == "Slovakia" ~ "Slovak Republic", -->
<!--     country == "Czech Republic" ~ "Czechia", -->
<!--     country == "Luxemburg" ~ "Luxembourg", -->
<!--     TRUE ~ country -->
<!--   ))%>% -->
<!--              group_by(country)%>% -->
<!--              summarize(total = sum(`eur`, na.rm=T))%>% -->
<!--   left_join(pop_data, -->
<!--             by = c("country" = "country"))%>% -->
<!--   mutate(total_pp = total / SP.POP.TOTL) -->

<!-- ggplot()+ -->
<!--   geom_bar(plotdata, -->
<!--            mapping = aes(x = reorder(country, total_pp), -->
<!--                          y = total_pp), -->
<!--            stat = "identity")+ -->
<!--   coord_flip()+ -->
<!--   scale_y_continuous(labels = label_dollar(prefix = "", suffix = "€",))+ -->
<!--   theme(axis.title = element_blank()) -->

<!-- ``` -->

### Total grants per "project" (Top 10 projects)

```{r echo = FALSE, fig.width=10}
plotdata <- data %>%
             group_by(`project`) %>%
             summarize(total = sum(`eur`, na.rm=T)) %>%
  arrange(desc(total))%>%
  mutate(project_title_clean = if_else(row_number() > 10, "other", `project`))%>%
  mutate(label = str_c(substr(`project`, 1, 30), "..."))

## create colors for top 10 projects
colors <- scales::viridis_pal()(10)
names(colors) <- plotdata$`project`[1:10]

ggplot(plotdata %>% 
             head(10),
       aes(x = reorder(`project`, total),
                         y = total))+
  geom_bar(mapping = aes(fill =  `project`),
           stat = "identity")+
  geom_text(mapping = aes(label = label),
            hjust = 0,
            size = 3)+
  coord_flip()+
  theme(legend.position = "none")+
  # scale_x_discrete(labels=short_labels_orders)+
  scale_fill_manual(values = colors)+
  scale_y_continuous(labels = label_dollar(prefix = "", suffix = "€"))+
  theme(axis.title = element_blank(),
        axis.text.y = element_blank())

```

#### Color legend for project titles

```{r echo =FALSE, fig.width=10}
ggplot()+
  geom_bar(plotdata %>% 
             head(10),
       mapping = aes(x = reorder(`project`, total),
                         y = 1,
           fill =  `project`),
           stat = "identity")+
  scale_x_discrete(position = "top")+
  scale_fill_manual(values = colors)+
  theme(legend.position = "none",
        text = element_text(size=10),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank())+
  coord_flip()

```
```{r echo =FALSE, message = FALSE}

# plotdata %>% head(10) %>% pull(`project`)

```

### Total of grants recieved by state, colored by project

Label per country for the project it got most grants by

```{r echo = FALSE, message = FALSE, fig.width=10}

plotdata <- data %>%
             group_by(country, `project`)%>%
             summarize(total_project = sum(`eur`, na.rm=T))%>%
  group_by(country)%>%
             mutate(total = sum(total_project, na.rm=T))%>%
  mutate(project_title_clean = if_else(`project` %in% names(colors), `project`, "other"))%>%
  group_by(country)%>%
  arrange(desc(total_project))%>%
  mutate(label = case_when(row_number() == 1 ~ `project`))%>%
  fill(label, .direction = "down")%>%
  ungroup()

ggplot(plotdata)+
  geom_bar(mapping = aes(x = reorder(country, total),
                         y = total_project,
                         fill = `project`),
           stat = "identity")+
  geom_text(mapping = aes(x = reorder(country, total),
                          y = total,
    label = label),
    hjust = 0,
    size = 3)+
  coord_flip()+
  theme(legend.position = "none")+
  scale_fill_manual(values = colors)+
  scale_y_continuous(labels = label_dollar(prefix = "", 
                                           suffix = "€"), 
                                           limits = c(0,60000000))+
  theme(axis.title = element_blank())

# ggplot(plotdata %>% 
#          group_by(`project`)%>%
#          summarize(total_project = sum(total_project))%>%
#          arrange(desc(total_project))%>%
#          head(12)%>%
#          mutate(label = substr(`project`, 1, 20)),
#        aes(x = reorder(`project`, total_project),
#                          y = total_project))+
#   geom_bar(mapping = aes(fill = `project`),
#            stat = "identity")+
#   geom_text(mapping = aes(label = label), hjust = 0)+
#   coord_flip()+
#   theme(legend.position = "none")+
#   scale_fill_manual(values = colors)+
#   scale_y_continuous(labels = label_dollar(prefix = "", suffix = "€",))+
#   theme(axis.title = element_blank(),
#         axis.text.y = element_blank())

```

### Total amount by beneficiaries per country

```{r echo =FALSE, fig.width=10, fig.height=30, warning = FALSE, message=FALSE}

# plotdata <- data%>%
#              group_by(country, `beneficiary`)%>%
#              summarize(total = sum(`eur`, na.rm=T))
# 
# ggplot(data = plotdata,
#        aes(axis1 = country, axis2 = `beneficiary`, y = total)) +
#   geom_alluvium(aes(fill = country)) +
#   geom_stratum() +
#   geom_text(stat = "stratum",
#             aes(label = after_stat(stratum))) +
#   scale_x_discrete(limits = c("country", "beneficiary"),
#                    expand = c(0.15, 0.05)) +
#   theme_void()+
#   theme(legend.position = "none",
#         text = element_text(size=10))

# plotdata <- data %>%
#              group_by(country, `beneficiary`)%>%
#              summarize(total = sum(`eur`, na.rm=T))%>%
#   mutate(x = "country", 
#                next_x = "beneficiary")
# 
# ggplot(plotdata %>% head(10), aes(x = x, 
#                next_x = next_x, 
#                node = country, 
#                next_node = `beneficiary`,
#                fill = factor(country),
#                label = `beneficiary`)) +
#   geom_sankey(flow.alpha = 0.5, node.color = 1) +
#   geom_sankey_label(size = 5, color = 1, fill = "white") +
#   scale_fill_viridis_d(option = "A") +
#   theme_sankey(base_size = 16) +
#   theme(legend.position = "none")

plotdata <- data %>%
             group_by(country, `beneficiary`)%>%
             summarize(total = sum(`eur`, na.rm=T))

Nodes <- data.frame(
  Name = c(plotdata$country, plotdata$`beneficiary`)%>% unique()
)
  

plotdata <- plotdata %>% 
  mutate(
  IDSource = match(country, Nodes$Name)-1,
  IDTarget = match(`beneficiary`, Nodes$Name)-1
) 

sankeyNetwork(Links = plotdata, Nodes = Nodes,
              Source = "IDSource", Target = "IDTarget",
              Value = "total", NodeID = "Name",
              sinksRight=FALSE)
```
